<!DOCTYPE html>
<html>
<head>
    <meta content="text/html; charset=UTF-8" http-equiv="content-type" />
    <title>PeoplePicker Playground</title>
    <style type="text/css">
        td.ppcontainer {
/*            border: 1px solid black;*/
            width: 600px;
        }
    </style>
    <script type="text/javascript" src="DetectVersion.js"></script>
    <script type="text/javascript" src="DataProvider.js"></script>
    <script type="text/javascript" src="AadDataProvider.js"></script>

</head>
<body>

    <h2>PeoplePicker</h2>

    <table style="width: 100%; border: 0px">
        <tr>
            <td style="vertical-align:top">
                <!-- Known Issues -->
                <div>
                    <h3>Before you start</h3>
                    <ul>
                        <li>Recommend to use <b style="color: #0000EE">InPrivate</b> browsing.</li>
                        <li>Need <b style="color: #0000EE">login</b> first otherwise will get 'Sorry, we're having trouble reaching the server.' error.</li>
                    </ul>
                </div>

                <!-- Playground -->
                <div>
                    <h3>Playground</h3>
                    <p>
                        <u>AAD data:</u>
                        &nbsp;&nbsp;&nbsp;&nbsp;<a id="login_user">Login</a>&nbsp;&nbsp;
                        <img src="images/questionmark.png" onclick="showLoginInstructions();" style="cursor:pointer;position:relative;top:5px"/></span>&nbsp;&nbsp;&nbsp;&nbsp;
                        <span id="logged_user"></span>
                    </p><p></p>
                    <table style="vertical-align:top">
                        <tr>
                            <td style="vertical-align:top;text-align:right">Single Selection</td>
                            <td style="vertical-align:top" class="ppcontainer"><div id='ppc_single'></div></td>
                        </tr>
                        <tr>
                            <td style="vertical-align:top;text-align:right">Multiple Selection</td>
                            <td style="vertical-align:top" class="ppcontainer">
                                <div id='ppc_multiple'></div>
                                <div id='ppc_multiple_error' style="color: red"></div>
                                <div id='ppc_multiple_people' style="color: blue"></div>
                            </td>
                        </tr>
                    </table>
                    <p/>
                    <p><u>Mock data:</u>&nbsp;&nbsp;&nbsp;&nbsp;<input type='checkbox' onclick='checkbox_ignore_click(this);' />Ignore keyword and show all results.<div id='ppc_mock'></div></p>
                </div>

                <p />

                <!-- Links -->
                <div>
                    <h3>Links</h3>
                    <p>
                        <a href="devex.html">Instructions</a>
                        &nbsp;&nbsp;&nbsp;&nbsp;<a href="spaindex.html">Use Single Page Application</a>
                        &nbsp;&nbsp;&nbsp;&nbsp;<a href="TestPage.html">Test Cases</a>
                        &nbsp;&nbsp;&nbsp;&nbsp;<a href="ts/tssample.html">TypeScript Sample</a>
                    </p>
                </div>
            </td>
            <td style="text-align:right; vertical-align:top">
                <div id="login_instructions" style="background-color:yellow;display:none">
                    You need login first to access data with people control.
                    <h3>Your Org Account</h3>
                    <p>Recommend to use your primary org account (like alias@microsoft.com) to have a try.</p>
                    <p>You need to do consent at first login.</p>
                    <h3>Other Tenant/Account</h3>
                    <p>We've also prepared demo tenants in <a href="devex.html">Instructions</a> page which has done consent for you.</p>
                </div>
            </td>
        </tr>
    </table>
    

    <script type="text/javascript">
        if (typeof Office !== "undefined") {
            creatPeoplePickers();
        }else {
            var timerId = window.setInterval(function () {
                if (typeof Office !== "undefined") {
                    window.clearInterval(timerId);
                    creatPeoplePickers();
                }
            }, 100);
        }

        function creatPeoplePickers() {
            var serverHost = 'localhost:3000';
            if (window.location.href.indexOf('azurewebsites.net') != -1) {
                serverHost = '***REMOVED***';
            }
            var pageUri = window.location.href;
            pageUri = pageUri.split("?")[0];

            document.getElementById('login_user').href = 'http://' + serverHost + '/authcode?redirect_uri=' + pageUri;

            var userId = getQueryString()["userId"];
            if (typeof (userId) !== 'undefined') {
                document.getElementById('logged_user').innerText = "logged as " + userId;
            }

            // Mock data
            var mockDataProvider = new MockDataProvider();
            var pp = new Office.Controls.PeoplePicker(document.getElementById('ppc_mock'), mockDataProvider, {});
            document.getElementById('ppc_mock').datapp = pp;

            // AAD data
            var aadDataProvider = new AadDataProvider();
            aadDataProvider.serverHost = serverHost;

            params = new Object();
            params.allowMultipleSelections = false;
            params.enableCache = true;
            params.showValidationErrors = true;
            new Office.Controls.PeoplePicker(document.getElementById('ppc_single'), aadDataProvider, params);

            params.allowMultipleSelections = true;
            params.startSearchCharLength = 1;
            params.inputHint = "Try to select multiple records...";
            params.showValidationErrors = false;
            params.onError = function (control, validationError) {
                if (validationError.errorName == 'ServerProblem') {
                    document.getElementById('ppc_multiple_error').innerHTML = "<pre>" + aadDataProvider.lastErrorMessage + "</pre>";
                } else {
                    document.getElementById('ppc_multiple_error').innerHTML = "<pre>" + validationError.localizedErrorMessage + "</pre>";
                }
            };
            params.onAdded = params.onRemoved = function (control) {
                document.getElementById('ppc_multiple_error').innerHTML = "";
                var people = 'Added people: ';
                control.getAddedPeople().forEach(
                    function (e) {
                        people += '<p>{' + e.DisplayName + ', id=' + e.PersonId + '}</p>';
                    });
                document.getElementById('ppc_multiple_people').innerHTML = "<pre>" + people + "</pre>";
            }
            pp = new Office.Controls.PeoplePicker(document.getElementById('ppc_multiple'), aadDataProvider, params);
            document.getElementById('ppc_multiple').datapp = pp;

            document.getElementById('login_instructions').style.display = 'none';

        }
        function checkbox_ignore_click(cb) {
            mockDataProvider.ignoreKeyword = cb.checked;
        }

        function showLoginInstructions() {
            var display = document.getElementById('login_instructions').style.display;
            document.getElementById('login_instructions').style.display = (display === 'none') ? 'inherit' : 'none';
        }

        function getQueryString() {
            var result = {}, queryString = location.search.slice(1),
                re = /([^&=]+)=([^&]*)/g, m;

            while (m = re.exec(queryString)) {
                result[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
            }

            return result;
        }

    </script>
</body>
</html>
